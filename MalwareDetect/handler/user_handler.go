package handler

import (
	"MalwareDetect/model"
	"MalwareDetect/util/errors"
	"MalwareDetect/util/response"
	"MalwareDetect/util/strs"
	"fmt"
	"log"
	"net/http"

	"github.com/gin-gonic/gin"
	"github.com/jinzhu/gorm"
)

// Register .
// @router /api/auth/register [POST]
func Register(ctx *gin.Context) {
	db := InitDB()
	defer db.Close()

	var requestUser = model.User{}
	ctx.Bind(&requestUser)

	username := requestUser.Name
	telephone := requestUser.Telephone
	password := requestUser.Password
	if err := checkRegisterParams(username, password, telephone); err != nil {
		response.Response(ctx, http.StatusUnprocessableEntity, 422, nil, err.Error())
		return
	}
	log.Println("name:", username, "password:", password, "telephone:", telephone)
	if checkUserExistByPhone(db, telephone) {
		response.Response(ctx, http.StatusUnprocessableEntity, 422, nil, "user already exist")
		return
	}
	createUser(db, username, password, telephone)
	response.Success(ctx, gin.H{"token": ""}, "注册成功")
}

func checkRegisterParams(username string, password string, telephone string) error {
	if len(username) == 0 {
		username = strs.RandomString(5)
	}
	if len(password) < 6 {
		return errors.New("length of password should not less than 6")
	}
	if len(telephone) != 1 {
		return errors.New("length of telephone should be 11")
	}
	return nil
}

func checkUserExistByPhone(db *gorm.DB, telephone string) bool {
	var user model.User
	db.Where("telephone = ?", telephone).First(&user)
	if user.ID != 0 {
		return true
	}
	return false
}

func createUser(db *gorm.DB, username string, password string, telephone string) {
	newUser := model.User{
		Name:      username,
		Password:  password,
		Telephone: telephone,
	}
	db.Create(&newUser)
}

func InitDB() *gorm.DB {
	driverName := "mysql"
	host := "localhost"
	port := "3306"
	database := "malware_detect_system"
	username := "root"
	password := "root"
	charset := "utf8"
	args := fmt.Sprintf("%s:%s@tcp(%s:%s)/%s?charset=%s&parseTime=true",
		username,
		password,
		host,
		port,
		database,
		charset)

	db, err := gorm.Open(driverName, args)
	if err != nil {
		panic("fail to connect database, err:" + err.Error())
	}
	db.AutoMigrate(&model.User{})
	return db
}
