package handler

import (
	"MalwareDetect/dao"
	"MalwareDetect/model"
	"MalwareDetect/model/vo"
	"MalwareDetect/util/response"
	"fmt"
	"log"
	"strconv"

	"github.com/gin-gonic/gin"
)

type IMalwareHandler interface {
	CURDHandler
}

type MalwareHandler struct {
	MalwareDaoInstance dao.MalwareDao
}

func NewMalwareHandler() IMalwareHandler {
	instance := dao.NewMalwareDao()
	instance.DB.AutoMigrate(model.Malware{})
	return MalwareHandler{MalwareDaoInstance: instance}
}

func (m MalwareHandler) Create(ctx *gin.Context) {
	var req vo.CreateMalwareRequest
	if err := ctx.ShouldBind(&req); err != nil {
		log.Print(err.Error())
		response.Fail(ctx, "数据验证错误", nil)
		return
	}

	// find user
	user, _ := ctx.Get("user")

	malware, err := m.MalwareDaoInstance.Create(user.(model.User).ID, req)
	if err != nil {
		log.Println(fmt.Sprintf("[CategoryHandler] create fail, err:%s", err.Error()))
		panic(err)
		return
	}
	response.Success(ctx, gin.H{"malware": malware}, "")

}

func (m MalwareHandler) Update(ctx *gin.Context) {
	var req vo.CreateMalwareRequest
	// 数据验证
	if err := ctx.ShouldBind(&req); err != nil {
		log.Print(err.Error())
		response.Fail(ctx, "数据验证错误", nil)
		return
	}

	postId := ctx.Params.ByName("id")

	var updateMalware model.Malware
	if m.MalwareDaoInstance.DB.Where("id = ?", postId).First(&updateMalware).RecordNotFound() {
		response.Fail(ctx, "malware不存在", nil)
		return
	}

	// 判断当前用户是否为malware的作者
	// 获取登录用户
	user, _ := ctx.Get("user")
	userId := user.(model.User).ID
	if userId != updateMalware.UserId {
		response.Fail(ctx, "该malware的上传者不属于您，无法修改", nil)
		log.Println(fmt.Sprintf("you are %d, this malware belongs to %d", userId, updateMalware.UserId))
		return
	}

	// 更新文章
	malware, err := m.MalwareDaoInstance.Update(updateMalware, req)
	if err != nil {
		log.Println(fmt.Sprintf("[MalwareHandler] update fail, err:%s", err.Error()))
		panic(err)
		return
	}

	response.Success(ctx, gin.H{"malware": malware}, "更新成功")
}

func (m MalwareHandler) Show(ctx *gin.Context) {
	malwareId, _ := strconv.Atoi(ctx.Params.ByName("id"))

	malware, err := m.MalwareDaoInstance.SelectById(malwareId)
	if err != nil {
		response.Fail(ctx, "malware不存在", nil)
		return
	}

	response.Success(ctx, gin.H{"malware": malware}, "成功")
}

func (m MalwareHandler) Delete(ctx *gin.Context) {
	// get id in path
	postId, _ := strconv.Atoi(ctx.Params.ByName("id"))

	// get user
	malware, err := m.MalwareDaoInstance.SelectById(postId)
	if err != nil {
		response.Fail(ctx, "malware不存在", nil)
		return
	}

	user, _ := ctx.Get("user")
	userId := user.(model.User).ID
	if userId != malware.UserId {
		response.Fail(ctx, "malware不属于您，请勿非法操作", nil)
		log.Println(fmt.Sprintf("you are %d, this malware belongs to %d", userId, malware.UserId))
		return
	}

	if err = m.MalwareDaoInstance.DeleteById(postId); err != nil {
		return
	}

	response.Success(ctx, gin.H{"malware": malware}, "删除成功")
}

func (c MalwareHandler) PageList(ctx *gin.Context) {
	// 获取分页参数
	pageNum, _ := strconv.Atoi(ctx.DefaultQuery("pageNum", "1"))
	pageSize, _ := strconv.Atoi(ctx.DefaultQuery("pageSize", "20"))

	// 分页, 按照创建时间排序
	malwares, err := c.MalwareDaoInstance.Order("created_at desc", pageNum, pageSize)
	if err != nil {
		response.Fail(ctx, err.Error(), nil)
		return
	}
	// 记录的总条数
	total := c.MalwareDaoInstance.Count()

	// 返回数据
	response.Success(ctx, gin.H{"data": malwares, "total": total}, "成功")
}
